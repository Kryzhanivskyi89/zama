<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Donor Match ‚Äî Zama FHEVM</title>
  <link rel="stylesheet" href="./index.css" />
  <!-- <style>
    :root {
      --bg: radial-gradient(circle at 30% 20%, #1f2937, #0a0a0a);
      --card-bg: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.15);
      --text: #f3f4f6;
      --accent: #38bdf8;
      --accent2: #a78bfa;
      --radius: 20px;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; padding: 40px; }
    .container { max-width: 1200px; margin: auto; display: flex; flex-direction: column; gap: 30px; }
    header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    h1 { font-size: 1.8rem; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; color: transparent; margin: 0; }
    h2 { font-size: 1.2rem; margin: 0 0 16px 0; }
    .btn { border: none; border-radius: var(--radius); padding: 12px 20px; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; transition: all 0.25s; }
    .btn:hover { filter: brightness(1.15); transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); }
    .btn-success { background: linear-gradient(135deg, var(--success), #059669); }
    .card { backdrop-filter: blur(12px); background: var(--card-bg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 28px; box-shadow: 0 4px 25px rgba(0,0,0,0.25); }
    label { display: block; margin-top: 12px; font-weight: 600; font-size: 14px; color: #cbd5e1; }
    select, input { width: 100%; margin-top: 6px; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06); color: var(--text); font-size: 15px; }
    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 40px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    .col { flex: 1; min-width: 200px; }
    pre { background: rgba(255,255,255,0.06); border: 1px dashed var(--border); border-radius: 12px; padding: 12px; overflow:auto; font-size: 12px; max-height: 300px; }
    .status { font-size: 14px; padding: 8px 12px; border-radius: 8px; margin-top: 8px; }
    .status.pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .status.success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .status.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .info-item { padding: 12px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    .info-label { font-size: 12px; color: #9ca3af; }
    .info-value { font-weight: 600; margin-top: 4px; }
    footer { text-align: center; color: #9ca3af; font-size: 13px; margin-top: 40px; }
    .divider { height: 1px; background: var(--border); margin: 20px 0; }
    .match-result { padding: 16px; background: rgba(16, 185, 129, 0.15); border-left: 4px solid var(--success); border-radius: 8px; margin-top: 16px; }
    .match-result.no-match { background: rgba(239, 68, 68, 0.15); border-left-color: var(--error); }
  </style> -->
<link rel="stylesheet" href="../src/styles/index.css" />

</head>
<body>
  <div class="container">
    <header>
      <h1>üíâ Private Donor Match</h1>
      <button id="btnConnect" class="btn">Connect Wallet</button>
    </header>

    <!-- SUBMIT DONOR SECTION -->
    <section class="card">
      <h2>1Ô∏è‚É£ Submit Donor Profile</h2>
      <p style="color: #9ca3af; font-size: 14px;">Register as a donor with encrypted blood type, Rh factor, and HLA score</p>
      
      <label>Blood Type (0=A, 1=B, 2=AB, 3=O)</label>
      <select id="donorBloodType">
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">AB</option>
        <option value="3" selected>O</option>
      </select>

      <label>Rh Factor (0=Negative, 1=Positive)</label>
      <select id="donorRh">
        <option value="0">Negative (‚àí)</option>
        <option value="1" selected>Positive (+)</option>
      </select>

      <label>HLA Match Score (0‚Äì10000)</label>
      <input id="donorHlaScore" type="number" min="0" max="10000" value="8500"/>

      <div class="row">
        <button id="btnSubmitDonor" class="btn">Register as Donor</button>
        <div id="donorStatus" class="status" style="display:none;"></div>
      </div>
      <div id="donorInfo" class="info-grid" style="display:none;">
        <div class="info-item">
          <div class="info-label">Donor ID</div>
          <div class="info-value" id="donorIdDisplay">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Your Address</div>
          <div class="info-value" id="donorAddressDisplay" style="font-size: 12px;">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- SUBMIT RECIPIENT SECTION -->
    <section class="card">
      <h2>2Ô∏è‚É£ Submit Recipient Profile</h2>
      <p style="color: #9ca3af; font-size: 14px;">Register as a recipient needing a match</p>
      
      <label>Blood Type (0=A, 1=B, 2=AB, 3=O)</label>
      <select id="recipientBloodType">
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">AB</option>
        <option value="3" selected>O</option>
      </select>

      <label>Rh Factor (0=Negative, 1=Positive)</label>
      <select id="recipientRh">
        <option value="0">Negative (‚àí)</option>
        <option value="1" selected>Positive (+)</option>
      </select>

      <label>HLA Match Score (0‚Äì10000)</label>
      <input id="recipientHlaScore" type="number" min="0" max="10000" value="7500"/>

      <div class="row">
        <button id="btnSubmitRecipient" class="btn btn-secondary">Register as Recipient</button>
        <div id="recipientStatus" class="status" style="display:none;"></div>
      </div>
      <div id="recipientInfo" class="info-grid" style="display:none;">
        <div class="info-item">
          <div class="info-label">Recipient ID</div>
          <div class="info-value" id="recipientIdDisplay">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Your Address</div>
          <div class="info-value" id="recipientAddressDisplay" style="font-size: 12px;">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- COMPUTE MATCH SECTION -->
    <section class="card">
      <h2>üîç 3Ô∏è‚É£ Compute Match</h2>
      <p style="color: #9ca3af; font-size: 14px;">Find compatibility between donor and recipient using homomorphic encryption</p>
      
      <div class="row">
        <div class="col">
          <label>Donor ID</label>
          <input id="matchDonorId" type="number" min="1" value="1"/>
        </div>
        <div class="col">
          <label>Recipient ID</label>
          <input id="matchRecipientId" type="number" min="1" value="1"/>
        </div>
        <div class="col">
          <label>HLA Threshold (min score)</label>
          <input id="matchThreshold" type="number" min="0" max="10000" value="7000"/>
        </div>
      </div>

      <div class="row">
        <button id="btnComputeMatch" class="btn btn-success">Compute Match (Homomorphic)</button>
        <div id="matchStatus" class="status" style="display:none;"></div>
      </div>
      <pre id="matchHandleOutput" style="display:none;">‚Äî</pre>
    </section>

    <!-- DECRYPT MATCH SECTION -->
    <section class="card">
      <h2>üîì 4Ô∏è‚É£ Retrieve & Decrypt Match Result</h2>
      <p style="color: #9ca3af; font-size: 14px;">Make match result public and decrypt it</p>
      
      <div class="row">
        <div class="col">
          <label>Donor ID</label>
          <input id="decryptDonorId" type="number" min="1" value="1"/>
        </div>
        <div class="col">
          <label>Recipient ID</label>
          <input id="decryptRecipientId" type="number" min="1" value="1"/>
        </div>
      </div>

      <div class="row">
        <button id="btnGetHandle" class="btn btn-secondary">Get Match Handle</button>
        <button id="btnMakePublic" class="btn">Make Public</button>
        <button id="btnDecrypt" class="btn btn-success">Decrypt Result</button>
      </div>

      <div id="decryptStatus" class="status" style="display:none;"></div>
      <div id="matchResult" class="match-result" style="display:none;"></div>
    </section>

    <footer>
      <div class="footer-container">
        <div class="footer-content">
          <!-- SOCIAL SECTION -->
          <div class="footer-section">
            <p class="footer-section-title">My social profiles:</p>
            <div class="social-links">
              <a 
                href="http://www.linkedin.com/in/andrii-kryzhanivskyi/"
                target="_blank"
                rel="noopener noreferrer"
                class="social-link"
                title="LinkedIn"
                aria-label="LinkedIn Profile"
              >
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor" stroke="none" color="white">
                  <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                </svg>
              </a>
              <a 
                href="https://github.com/Kryzhanivskyi89"
                target="_blank"
                rel="noopener noreferrer"
                class="social-link"
                title="GitHub"
                aria-label="GitHub Profile"
              >
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor" stroke="none" color="white">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
              </a>
              <a 
                href="https://t.me/andrew_506"
                target="_blank"
                rel="noopener noreferrer"
                class="social-link"
                title="Telegram"
                aria-label="Telegram Profile"
              >
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor" stroke="none" color="white">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.16.16-.295.295-.605.295-.037 0-.074 0-.11-.01l.214-3.053 5.56-5.023c.242-.213-.054-.336-.375-.123l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.136-.954l11.566-4.458c.54-.197 1.011.131.844 1.955z"/>
                </svg>
              </a>
            </div>
          </div>

          <!-- CONTACTS SECTION -->
          <div class="footer-section">
            <p class="footer-section-title">Contact with me:</p>
            <div class="contact-links">
              <a 
                href="mailto:kryzhanivskyi.an@gmail.com"
                target="_blank"
                rel="noopener noreferrer nofollow"
                class="contact-link"
                title="Send email"
              >
                <svg class="contact-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="white">
                  <rect x="2" y="4" width="20" height="16" rx="2"/>
                  <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                </svg>
                <span class="contact-text">kryzhanivskyi.an@gmail.com</span>
              </a>
              <a 
                href="tel:+380990783060"
                class="contact-link"
                title="Call phone"
              >
                <svg class="contact-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="white">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                <span class="contact-text">+380990783060</span>
              </a>
            </div>
          </div>
        </div>

        <!-- BRAND SECTION -->
        <div class="footer-brand">
          <p class="brand-text">Built with ‚ù§Ô∏è & Zama FHEVM ¬∑ Relayer SDK 0.3.0 ¬∑ Ethers v6</p>
          <p class="brand-text">Developed by:
            <a target="_blank" class="brand-text" href="https://kryzhanivskyi89.github.io/portfolio/">&lt;AndrewDev/&gt;</a>
          </p>
          <p class="copyright">¬© 2025 All rights reserved</p>
        </div>
      </div>
    </footer>
  </div>
<script type="module" src="./index.js"></script>
  <!-- <script type="module">
   import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";
import { BrowserProvider, Contract, getAddress, keccak256, toUtf8Bytes } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";

const CONFIG = {
  RELAYER_URL: "https://relayer.testnet.zama.org",
  GATEWAY_URL: "https://gateway.testnet.zama.org",
  CONTRACT_ADDRESS: "0x2B9f07dA98989A42da53493f7fC19Ee549BfD4Cc"
};

const ABI = [
  "function submitDonor(bytes32,bytes32,bytes32,bytes) external returns (uint256)",
  "function submitRecipient(bytes32,bytes32,bytes32,bytes) external returns (uint256)",
  "function computeMatch(uint256,uint256,bytes32,bytes) external returns (bytes32)",  // ‚úÖ 4 –ø–∞—Ä–∞–º–µ—Ç—Ä–∏!
  "function makeMatchPublic(uint256,uint256) external",
  "function matchHandle(uint256,uint256) external view returns (bytes32)",
  "function donorExists(uint256) external view returns (bool)",
  "function recipientExists(uint256) external view returns (bool)",
  "function donorOwner(uint256) external view returns (address)",
  "function recipientOwner(uint256) external view returns (address)"
];

let provider, signer, address, contract, relayer;
const $ = s => document.querySelector(s);

// ============ LOGS ============
const log = (title, data) => {
  console.log(`%c[${title}]`, "color: #38bdf8; font-weight: bold;", data);
};

const logError = (title, err) => {
  console.error(`%c[ERROR: ${title}]`, "color: #ef4444; font-weight: bold;", err);
};

const logSuccess = (title, data) => {
  console.log(`%c[SUCCESS: ${title}]`, "color: #10b981; font-weight: bold;", data);
};

// ============ HELPERS ============
const toHex = u8 => '0x' + Array.from(u8, b => b.toString(16).padStart(2,'0')).join('');

const setStatus = (id, msg, type = 'pending') => {
  const el = $(id);
  if (!el) {
    log("Status Element Not Found", `ID: ${id}`);
    return;
  }
  el.textContent = msg;
  el.className = `status ${type}`;
  el.style.display = 'block';
  log(`Status [${id}]`, msg);
};

const clearStatus = (id) => {
  const el = $(id);
  if (el) el.style.display = 'none';
};

// ============ WALLET CONNECTION ============
async function connect() {
  try {
    log("Connect Wallet", "Starting connection...");
    
    if (!window.ethereum) {
      throw new Error("MetaMask not installed");
    }
    log("Window.ethereum", "Found");

    provider = new BrowserProvider(window.ethereum);
    log("Provider", "Created");
    
    const accounts = await provider.send("eth_requestAccounts", []);
    log("Accounts Requested", accounts);
    
    signer = await provider.getSigner();
    log("Signer", "Got signer");
    
    address = await signer.getAddress();
    log("Address", address);
    
    contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);
    log("Contract Instance", `Address: ${CONFIG.CONTRACT_ADDRESS}`);
    
    $("#btnConnect").textContent = address.slice(0, 6) + "‚Ä¶" + address.slice(-4);

    if (!relayer) {
      log("Relayer Init", "Initializing SDK...");
      await initSDK();
      log("SDK Initialized", "Creating instance...");
      
      relayer = await createInstance({
        ...SepoliaConfig,
        relayerUrl: CONFIG.RELAYER_URL,
        gatewayUrl: CONFIG.GATEWAY_URL,
        network: window.ethereum,
        debug: true
      });
      logSuccess("Relayer", "Instance created");
    }
    
    logSuccess("Connection", "Full setup complete");
    return true;
  } catch (e) {
    logError("Connect", e);
    setStatus("#donorStatus", "‚ùå Wallet connection failed", "error");
    return false;
  }
}

$("#btnConnect").onclick = connect;

// ============ SUBMIT DONOR ============
$("#btnSubmitDonor").onclick = async () => {
  try {
    log("Submit Donor", "Starting...");
    
    if (!await connect()) {
      logError("Submit Donor", "Connection failed");
      return;
    }

    setStatus("#donorStatus", "üìù Encrypting donor profile‚Ä¶", "pending");

    const bloodType = parseInt($("#donorBloodType").value);
    const rh = parseInt($("#donorRh").value);
    const hlaScore = parseInt($("#donorHlaScore").value);

    log("Donor Values", { bloodType, rh, hlaScore });

    const enc = relayer.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
    log("Encrypted Input Created", "Adding values...");
    
    enc.add8(BigInt(bloodType));
    log("Added Blood Type", bloodType);
    
    enc.add8(BigInt(rh));
    log("Added Rh", rh);
    
    enc.add16(BigInt(hlaScore));
    log("Added HLA Score", hlaScore);

    const { handles, inputProof } = await enc.encrypt();
    log("Encryption Result", { 
      handleCount: handles.length,
      proofLength: typeof inputProof === "string" ? inputProof.length : inputProof.length 
    });

    // ‚úÖ FIX: Convert each Uint8Array to hex string (bytes32 format)
    const h1 = typeof handles[0] === "string" 
      ? handles[0] 
      : (handles[0]?.handle || handles[0]?.ciphertext || toHex(handles[0]));
    
    const h2 = typeof handles[1] === "string" 
      ? handles[1] 
      : (handles[1]?.handle || handles[1]?.ciphertext || toHex(handles[1]));
    
    const h3 = typeof handles[2] === "string" 
      ? handles[2] 
      : (handles[2]?.handle || handles[2]?.ciphertext || toHex(handles[2]));

    const att = typeof inputProof === "string" 
      ? (inputProof.startsWith("0x") ? inputProof : "0x" + inputProof) 
      : toHex(inputProof);

    log("Handles Extracted (CONVERTED)", {
      h1: typeof h1 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      h2: typeof h2 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      h3: typeof h3 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      attLength: att.length,
      allHex: typeof h1 === "string" && typeof h2 === "string" && typeof h3 === "string"
    });

    console.log("üîπ Donor submit args (FIXED):", { 
      h1: h1.slice(0, 40) + "...", 
      h2: h2.slice(0, 40) + "...", 
      h3: h3.slice(0, 40) + "...", 
      att: att.slice(0, 50) + "..." 
    });

    setStatus("#donorStatus", "‚õìÔ∏è Submitting to blockchain‚Ä¶", "pending");
    
    const tx = await contract.submitDonor(h1, h2, h3, att);
    log("Transaction Sent", tx.hash);
    
    const receipt = await tx.wait();
    log("Transaction Confirmed", { 
      blockNumber: receipt.blockNumber,
      logCount: receipt.logs.length 
    });

    // Extract donor ID from event logs
    let donorId = 1;
    if (receipt.logs && receipt.logs.length > 0) {
      try {
        donorId = BigInt(receipt.logs[0]?.topics[2] || 1).toString();
        log("Donor ID Extracted", donorId);
      } catch (e) {
        logError("ID Extraction", e);
        donorId = "1";
      }
    }

    $("#donorIdDisplay").textContent = donorId;
    $("#donorAddressDisplay").textContent = address.slice(0, 6) + "‚Ä¶" + address.slice(-4);
    $("#donorInfo").style.display = 'grid';

    logSuccess("Submit Donor", `ID: ${donorId}`);
    setStatus("#donorStatus", `‚úÖ Donor registered! ID: ${donorId}`, "success");
    
    // Auto-populate match inputs
    $("#matchDonorId").value = donorId;
    $("#decryptDonorId").value = donorId;
    
  } catch (e) {
    logError("Submit Donor", e);
    setStatus("#donorStatus", "‚ùå Error: " + (e.message || e), "error");
  }
};

// ============ FIX FOR SUBMIT RECIPIENT ============
$("#btnSubmitRecipient").onclick = async () => {
  try {
    log("Submit Recipient", "Starting...");
    
    if (!await connect()) {
      logError("Submit Recipient", "Connection failed");
      return;
    }

    setStatus("#recipientStatus", "üìù Encrypting recipient profile‚Ä¶", "pending");

    const bloodType = parseInt($("#recipientBloodType").value);
    const rh = parseInt($("#recipientRh").value);
    const hlaScore = parseInt($("#recipientHlaScore").value);

    log("Recipient Values", { bloodType, rh, hlaScore });

    const enc = relayer.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
    log("Encrypted Input Created", "Adding values...");
    
    enc.add8(BigInt(bloodType));
    log("Added Blood Type", bloodType);
    
    enc.add8(BigInt(rh));
    log("Added Rh", rh);
    
    enc.add16(BigInt(hlaScore));
    log("Added HLA Score", hlaScore);

    const { handles, inputProof } = await enc.encrypt();
    log("Encryption Result", { 
      handleCount: handles.length,
      proofLength: typeof inputProof === "string" ? inputProof.length : inputProof.length 
    });

    // ‚úÖ FIX: Convert each Uint8Array to hex string (bytes32 format)
    const h1 = typeof handles[0] === "string" 
      ? handles[0] 
      : (handles[0]?.handle || handles[0]?.ciphertext || toHex(handles[0]));
    
    const h2 = typeof handles[1] === "string" 
      ? handles[1] 
      : (handles[1]?.handle || handles[1]?.ciphertext || toHex(handles[1]));
    
    const h3 = typeof handles[2] === "string" 
      ? handles[2] 
      : (handles[2]?.handle || handles[2]?.ciphertext || toHex(handles[2]));

    const att = typeof inputProof === "string" 
      ? (inputProof.startsWith("0x") ? inputProof : "0x" + inputProof) 
      : toHex(inputProof);

    log("Handles Extracted (CONVERTED)", {
      h1: typeof h1 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      h2: typeof h2 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      h3: typeof h3 === "string" ? "‚úÖ string (hex)" : "‚ùå NOT string",
      attLength: att.length,
      allHex: typeof h1 === "string" && typeof h2 === "string" && typeof h3 === "string"
    });

    console.log("üîπ Recipient submit args (FIXED):", { 
      h1: h1.slice(0, 40) + "...", 
      h2: h2.slice(0, 40) + "...", 
      h3: h3.slice(0, 40) + "...", 
      att: att.slice(0, 50) + "..." 
    });

    setStatus("#recipientStatus", "‚õìÔ∏è Submitting to blockchain‚Ä¶", "pending");
    
    const tx = await contract.submitRecipient(h1, h2, h3, att);
    log("Transaction Sent", tx.hash);
    
    const receipt = await tx.wait();
    log("Transaction Confirmed", { 
      blockNumber: receipt.blockNumber,
      logCount: receipt.logs.length 
    });

    let recipientId = 1;
    if (receipt.logs && receipt.logs.length > 0) {
      try {
        recipientId = BigInt(receipt.logs[0]?.topics[2] || 1).toString();
        log("Recipient ID Extracted", recipientId);
      } catch (e) {
        logError("ID Extraction", e);
        recipientId = "1";
      }
    }

    $("#recipientIdDisplay").textContent = recipientId;
    $("#recipientAddressDisplay").textContent = address.slice(0, 6) + "‚Ä¶" + address.slice(-4);
    $("#recipientInfo").style.display = 'grid';

    logSuccess("Submit Recipient", `ID: ${recipientId}`);
    setStatus("#recipientStatus", `‚úÖ Recipient registered! ID: ${recipientId}`, "success");
    
    // Auto-populate match inputs
    $("#matchRecipientId").value = recipientId;
    $("#decryptRecipientId").value = recipientId;
    
  } catch (e) {
    logError("Submit Recipient", e);
    setStatus("#recipientStatus", "‚ùå Error: " + (e.message || e), "error");
  }
};
// ============ COMPUTE MATCH ============

$("#btnComputeMatch").onclick = async () => {
  try {
    log("Compute Match", "Starting...");
    
    if (!await connect()) {
      logError("Compute Match", "Connection failed");
      return;
    }

    setStatus("#matchStatus", "üîç Verifying profiles‚Ä¶", "pending");

    const donorId = parseInt($("#matchDonorId").value);
    const recipientId = parseInt($("#matchRecipientId").value);
    const threshold = BigInt(parseInt($("#matchThreshold").value));

    log("Match IDs & Threshold", { donorId, recipientId, threshold: threshold.toString() });

    // ===== VERIFY EXISTENCE =====
    log("Verify Donor Exists", `ID: ${donorId}`);
    const donorExists = await contract.donorExists(donorId);
    log("Donor Exists Result", donorExists);
    
    if (!donorExists) {
      throw new Error(`‚ùå Donor ID ${donorId} does not exist!`);
    }

    log("Verify Recipient Exists", `ID: ${recipientId}`);
    const recipExists = await contract.recipientExists(recipientId);
    log("Recipient Exists Result", recipExists);
    
    if (!recipExists) {
      throw new Error(`‚ùå Recipient ID ${recipientId} does not exist!`);
    }

    logSuccess("Profiles Verified", "Both exist on contract");
    setStatus("#matchStatus", "üîê Encrypting threshold‚Ä¶", "pending");

    // ===== ENCRYPT THRESHOLD ===== 
    const enc = relayer.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
    log("Encrypted Input Created", "Adding threshold...");
    
    enc.add16(threshold);
    log("Added Threshold", threshold.toString());

    const { handles, inputProof } = await enc.encrypt();
    log("Threshold Encryption Result", { 
      handleCount: handles.length,
      proofLength: typeof inputProof === "string" ? inputProof.length : inputProof.length 
    });

    // ‚úÖ FIX: Get the encrypted threshold (handle)
    const encryptedThresholdRaw = handles[0]?.handle || handles[0]?.ciphertext || handles[0];
    const encryptedThreshold = typeof encryptedThresholdRaw === "string" 
      ? encryptedThresholdRaw 
      : toHex(encryptedThresholdRaw);

    // ‚úÖ FIX: Get the attestation
    const attestation = typeof inputProof === "string" 
      ? (inputProof.startsWith("0x") ? inputProof : "0x" + inputProof) 
      : toHex(inputProof);

    log("Threshold Encryption Extracted", {
      encryptedThresholdType: typeof encryptedThreshold,
      encryptedThresholdLength: encryptedThreshold.length,
      attestationLength: attestation.length,
      bothAreHex: typeof encryptedThreshold === "string" && typeof attestation === "string"
    });

    console.log("üîπ Match compute args (FIXED WITH ATTESTATION):", { 
      donorId, 
      recipientId, 
      encryptedThreshold: encryptedThreshold.slice(0, 50) + "...",
      attestation: attestation.slice(0, 50) + "...",
      paramCount: 4
    });

    setStatus("#matchStatus", "‚õìÔ∏è Computing match (homomorphic)‚Ä¶", "pending");
    
    log("Contract Call", `computeMatch(${donorId}, ${recipientId}, encryptedThreshold, attestation)`);
    
    // ‚úÖ PASS BOTH encryptedThreshold AND attestation (4 parameters total!)
    const tx = await contract.computeMatch(donorId, recipientId, encryptedThreshold, attestation);
    log("Transaction Sent", tx.hash);
    
    const receipt = await tx.wait();
    log("Transaction Confirmed", { 
      blockNumber: receipt.blockNumber,
      status: receipt.status === 1 ? "SUCCESS" : "FAILED"
    });

    if (receipt.status !== 1) {
      throw new Error("Transaction reverted on chain!");
    }

    setStatus("#matchStatus", "üìä Retrieving match handle‚Ä¶", "pending");

    // ===== GET HANDLE =====
    log("Get Match Handle", `For pair (${donorId}, ${recipientId})`);
    const handle = await contract.matchHandle(donorId, recipientId);
    log("Match Handle Retrieved", handle);

    $("#matchHandleOutput").textContent = "Match Handle:\n" + handle;
    $("#matchHandleOutput").style.display = 'block';

    logSuccess("Compute Match", `Complete! Handle: ${handle.slice(0, 20)}...`);
    setStatus("#matchStatus", "‚úÖ Match computed successfully!", "success");

    // Auto-populate decrypt inputs
    $("#decryptDonorId").value = donorId;
    $("#decryptRecipientId").value = recipientId;
    
  } catch (e) {
    logError("Compute Match", e);
    setStatus("#matchStatus", "‚ùå " + (e.message || e), "error");
  }
};

// ============ GET HANDLE ============
$("#btnGetHandle").onclick = async () => {
  try {
    log("Get Handle", "Starting...");
    
    if (!await connect()) return;

    const donorId = parseInt($("#decryptDonorId").value);
    const recipientId = parseInt($("#decryptRecipientId").value);

    log("Get Handle Params", { donorId, recipientId });
    
    setStatus("#decryptStatus", "üìä Retrieving handle‚Ä¶", "pending");
    
    const handle = await contract.matchHandle(donorId, recipientId);
    log("Handle Retrieved", handle);

    $("#matchHandleOutput").textContent = "Match Handle:\n" + handle;
    $("#matchHandleOutput").style.display = 'block';

    logSuccess("Get Handle", handle.slice(0, 30) + "...");
    setStatus("#decryptStatus", "‚úÖ Handle retrieved", "success");
  } catch (e) {
    logError("Get Handle", e);
    setStatus("#decryptStatus", "‚ùå " + (e.message || e), "error");
  }
};

// ============ MAKE PUBLIC ============

$("#btnMakePublic").onclick = async () => {
  try {
    log("Make Public", "Starting...");
    
    if (!await connect()) return;

    const donorId = parseInt($("#decryptDonorId").value);
    const recipientId = parseInt($("#decryptRecipientId").value);

    log("Make Public Params", { donorId, recipientId });
    
    setStatus("#decryptStatus", "üîì Making match public‚Ä¶", "pending");
    
    const tx = await contract.makeMatchPublic(donorId, recipientId);
    log("Transaction Sent", tx.hash);
    
    const receipt = await tx.wait();
    log("Transaction Confirmed", { 
      blockNumber: receipt.blockNumber,
      status: receipt.status === 1 ? "SUCCESS" : "FAILED"
    });

    logSuccess("Make Public", "Match is now decryptable");
    setStatus("#decryptStatus", "‚úÖ Match is now public", "success");
  } catch (e) {
    logError("Make Public", e);
    setStatus("#decryptStatus", "‚ùå " + (e.message || e), "error");
  }
};

// ========== PUBLIC DECRYPT  ==========
async function decryptMatch(handleHex) {
  if (!relayer) throw new Error("Relayer not initialized");

  const clean = String(handleHex).trim();

  if (!clean.startsWith("0x") || clean.length !== 66)
    throw new Error("Invalid handle format (must be bytes32)");

  // SDK 0.3.0-5 expects an array of ciphertext strings
  const request = [ clean ];

  console.log("üîé publicDecrypt request:", request);

  const out = await relayer.publicDecrypt(request);

  console.log("üîç publicDecrypt output:", out);

  if (!Array.isArray(out) || !out[0]) {
    throw new Error("Invalid decrypt response");
  }

  // possible formats:
  // [ "1" ]
  // [ { value: "1" } ]
  const item = out[0];

  const value =
    typeof item === "string"
      ? item
      : (item.value ?? null);

  if (value == null)
    throw new Error("Decrypt returned no value");

  return Number(value) === 1;
}

// ============ DECRYPT ============

$("#btnDecrypt").onclick = async () => {
  try {
    await connect();

    // extract only clean bytes32 handle
    const raw = $("#matchHandleOutput").textContent.trim();
    const handle = raw.split("\n").pop().trim();

    console.log("Decrypting handle:", handle);

    const isMatch = await decryptMatch(handle);

    console.log("MATCH =", isMatch);

    const donorId = $("#decryptDonorId").value;
    const recipientId = $("#decryptRecipientId").value;

    const resultDiv = $("#matchResult");

    if (isMatch) {
      resultDiv.className = "match-result";
      resultDiv.innerHTML =
        `<div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">‚úÖ MATCH FOUND!</div>
         <div style="color:#d1d5db;font-size:14px;">
            Donor #${donorId} and Recipient #${recipientId} are compatible!
         </div>`;
    } else {
      resultDiv.className = "match-result no-match";
      resultDiv.innerHTML =
        `<div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">‚ùå NO MATCH</div>
         <div style="color:#d1d5db;font-size:14px;">
            Donor #${donorId} and Recipient #${recipientId} are not compatible.
         </div>`;
    }

    resultDiv.style.display = "block";

    setStatus("#decryptStatus", "‚úÖ Match result decrypted", "success");

  } catch (e) {
    console.error("Decrypt failed:", e);
    setStatus("#decryptStatus", "‚ùå " + (e.message || e), "error");
  }
};

log("Script", "‚úÖ All handlers attached and ready");
  </script> -->


    <script type="module" src="../src/scripts/index.js"></script>
</body>
</html>