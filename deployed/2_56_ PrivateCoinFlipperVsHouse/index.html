<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Coin Flipper vs House ‚Äî Zama FHEVM</title>
  <style>
    :root {
      --bg: #050816;
      --panel: #0b1220;
      --panel-soft: #020617;
      --border-strong: #020617;
      --border-muted: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-alt: #06b6d4;
      --accent-hot: #f97316;
      --accent-danger: #ef4444;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-hard: 0 14px 0 #020617;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 26px 14px 32px;
      background:
        linear-gradient(135deg, #020617 0%, #020617 40%, #020617 100%),
        radial-gradient(circle at 0 0, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(248,113,113,0.22), transparent 65%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1120px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: var(--panel-soft);
      border-radius: 26px;
      border: 3px solid var(--border-strong);
      box-shadow:
        var(--shadow-hard),
        0 0 0 1px #000;
      padding: 20px 18px 24px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "ON-CHAIN COIN ARENA";
      position: absolute;
      top: 18px;
      right: -42px;
      transform: rotate(6deg);
      font-size: 10px;
      letter-spacing: 0.26em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.28);
      padding: 4px 22px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: #020617;
      box-shadow: 0 8px 0 #020617;
      pointer-events: none;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 14px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-muted);
    }

    h1 {
      margin: 0;
      font-size: 1.65rem;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    h1 span {
      padding: 3px 10px 5px;
      border-radius: 999px;
      border: 2px solid #facc15;
      background: #0f172a;
      font-size: 0.78rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #fef9c3;
    }

    h1 strong {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    h1 strong::before {
      content: "ü™ô";
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #facc15;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 0 #78350f;
    }

    header p {
      margin: 6px 0 0;
      font-size: 12px;
      line-height: 1.5;
      color: var(--muted);
      max-width: 360px;
    }

    h2 {
      font-size: 0.95rem;
      margin: 0 0 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    h2::before {
      content: "";
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: #0f172a;
      border: 2px solid var(--border-muted);
      box-shadow: 0 4px 0 #020617;
    }

    p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .btn {
      border-radius: 10px;
      padding: 10px 18px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      border: 2px solid #020617;
      background: #22c55e;
      color: #020617;
      box-shadow: 0 6px 0 #14532d;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background-color 0.08s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 0 #14532d;
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 3px 0 #14532d;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      background: #0b1120;
      color: var(--muted);
      box-shadow: 0 0 0 #020617;
    }

    .btn-secondary {
      background: #0ea5e9;
      box-shadow: 0 6px 0 #075985;
      color: #020617;
    }

    .btn-success {
      background: #22c55e;
      box-shadow: 0 6px 0 #166534;
      color: #020617;
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 2px solid var(--border-muted);
      box-shadow:
        0 10px 0 #020617,
        0 0 0 1px #020617;
      padding: 16px 16px 14px;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(120deg,
          rgba(249,115,22,0.16),
          transparent 30%,
          transparent 70%,
          rgba(56,189,248,0.16));
      mix-blend-mode: soft-light;
      opacity: 0.5;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.95);
    }

    input,
    select {
      width: 100%;
      margin-top: 6px;
      padding: 9px 10px;
      border-radius: var(--radius-md);
      border: 2px solid #020617;
      background: #020617;
      color: var(--text);
      font-size: 14px;
      outline: none;
      box-shadow:
        inset 0 0 0 1px #111827,
        0 6px 0 #020617;
      appearance: none;
    }

    select {
      background-image:
        linear-gradient(45deg, transparent 50%, #e5e7eb 50%),
        linear-gradient(135deg, #e5e7eb 50%, transparent 50%);
      background-position:
        calc(100% - 16px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 28px;
    }

    input:focus,
    select:focus {
      border-color: #facc15;
      box-shadow:
        inset 0 0 0 1px #111827,
        0 0 0 3px #facc15,
        0 6px 0 #020617;
      background: #020617;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }

    pre {
      background: #020617;
      border-radius: var(--radius-md);
      padding: 10px 11px;
      border: 2px solid #020617;
      outline: 1px solid #111827;
      overflow: auto;
      font-size: 11px;
      max-height: 220px;
      color: #e5e7eb;
      line-height: 1.5;
      box-shadow: inset 0 0 0 1px #0f172a;
    }

    .status {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      margin-top: 6px;
      border: 2px solid #020617;
      background: #020617;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      white-space: nowrap;
      box-shadow: 0 4px 0 #020617;
    }

    .status::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background-color: #64748b;
      border: 1px solid #0f172a;
    }

    .status.pending {
      color: #facc15;
      background: #0b1120;
    }

    .status.pending::before {
      background-color: #facc15;
    }

    .status.success {
      color: #bbf7d0;
      background: #052e16;
    }

    .status.success::before {
      background-color: #22c55e;
    }

    .status.error {
      color: #fecaca;
      background: #450a0a;
    }

    .status.error::before {
      background-color: #ef4444;
    }

    .match-result {
      padding: 14px 14px 12px;
      border-radius: var(--radius-lg);
      margin-top: 12px;
      border: 3px solid #22c55e;
      background: #052e16;
      color: #ecfdf5;
      box-shadow:
        0 8px 0 #022c22,
        0 0 0 1px #000;
    }

    .match-result.no-match {
      background: #7f1d1d;
      border-color: #ef4444;
      box-shadow:
        0 8px 0 #450a0a,
        0 0 0 1px #000;
    }

    footer {
      text-align: left;
      color: rgba(148,163,184,0.9);
      font-size: 11px;
      margin-top: 8px;
      padding-top: 10px;
      border-top: 2px dashed var(--border-muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
    }

    footer::before {
      content: "PLAYER VS HOUSE ¬∑ ENCRYPTED FLIPS";
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.85);
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 10px 22px;
      }

      .container {
        padding: 14px 12px 18px;
        border-radius: 22px;
        box-shadow:
          0 10px 0 #020617,
          0 0 0 1px #000;
      }

      header {
        align-items: flex-start;
      }

      h1 {
        font-size: 1.4rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn,
      .status {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1><strong>Private Coin Flipper</strong> <span>VS HOUSE</span></h1>
        <p>Biased on-chain coin, encrypted choices and verifiable wins ‚Äî flip privately, prove publicly.</p>
      </div>
      <button id="btnConnect" class="btn">Connect Wallet</button>
    </header>

    <!-- HOUSE: SET BIAS -->
    <section class="card">
      <h2>1Ô∏è‚É£ House: Set Encrypted Bias</h2>
      <p>
        The house encrypts its biased side of the coin (0 = heads, 1 = tails). Players never see it.
      </p>

      <label>House bias (0 = heads, 1 = tails)</label>
      <input id="biasInput" type="number" min="0" max="1" value="0"/>

      <div class="row">
        <button id="btnSetBias" class="btn btn-secondary">Set House Bias</button>
        <div id="biasStatus" class="status" style="display:none;"></div>
      </div>
    </section>

    <!-- PLAYER: PLAY FLIP -->
    <section class="card">
      <h2>2Ô∏è‚É£ Player: Encrypted Flip</h2>
      <p>
        Choose heads or tails (privately), encrypt your choice, and play against the house.
      </p>

      <label>Your choice</label>
      <select id="choiceInput">
        <option value="0">0 ‚Äî Heads</option>
        <option value="1">1 ‚Äî Tails</option>
      </select>

      <div class="row">
        <button id="btnPlayFlip" class="btn btn-success">Play Encrypted Flip</button>
        <div id="flipStatus" class="status" style="display:none;"></div>
      </div>

      <pre id="resultHandleOutput" style="display:none;">‚Äî</pre>
    </section>

    <!-- DECRYPT LAST RESULT -->
    <section class="card">
      <h2>3Ô∏è‚É£ Decrypt Last Flip Result</h2>
      <p>
        Make your last flip result public and decrypt it via Relayer.
      </p>

      <div class="row">
        <button id="btnGetResultHandle" class="btn btn-secondary">Get My Result Handle</button>
        <button id="btnMakeResultPublic" class="btn">Make My Result Public</button>
        <button id="btnDecryptResult" class="btn btn-success">Decrypt Result</button>
      </div>

      <div id="decryptResultStatus" class="status" style="display:none;"></div>
      <div id="flipResult" class="match-result" style="display:none;"></div>
    </section>

    <!-- DECRYPT TOTAL WINS -->
    <section class="card">
      <h2>4Ô∏è‚É£ Decrypt Total Wins vs House</h2>
      <p>
        Optionally, reveal your total number of encrypted wins against the house.
      </p>

      <div class="row">
        <button id="btnGetWinsHandle" class="btn btn-secondary">Get Wins Handle</button>
        <button id="btnMakeWinsPublic" class="btn">Make My Wins Public</button>
        <button id="btnDecryptWins" class="btn btn-success">Decrypt Wins</button>
      </div>

      <pre id="winsHandleOutput" style="display:none;">‚Äî</pre>
      <div id="winsStatus" class="status" style="display:none;"></div>
      <div id="winsResult" class="match-result" style="display:none;"></div>
    </section>

    <footer>
      Built with ‚ù§Ô∏è & Zama FHEVM ¬∑ Relayer SDK 0.3.0-5 ¬∑ Ethers v6
    </footer>
  </div>

  <script type="module">
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";
    import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";

    const CONFIG = {
      RELAYER_URL: "https://relayer.testnet.zama.org",
      GATEWAY_URL: "https://gateway.testnet.zama.org",
      CONTRACT_ADDRESS: "0x409f8a50e5d64CadE057Eb48a917E40C8320B404"
    };

    const ABI = [
      "function setHouseBias(bytes32,bytes) external",
      "function playFlip(bytes32,bytes) external returns (bytes32)",
      "function makeMyResultPublic() external",
      "function makeMyWinsPublic() external",
      "function resultHandle(address) external view returns (bytes32)",
      "function winsHandle(address) external view returns (bytes32)",
      "function hasBias() external view returns (bool)",
      "function hasPlayerResult(address) external view returns (bool)"
    ];

    let provider, signer, address, contract, relayer;
    const $ = s => document.querySelector(s);

    const log = (t,d) => console.log(`%c[${t}]`,"color:#38bdf8;font-weight:bold;",d);
    const logError = (t,e) => console.error(`%c[ERROR: ${t}]`,"color:#ef4444;font-weight:bold;",e);
    const logSuccess = (t,d) => console.log(`%c[SUCCESS: ${t}]`,"color:#10b981;font-weight:bold;",d);

    const toHex = u8 => "0x" + Array.from(u8, b => b.toString(16).padStart(2,"0")).join("");

    const setStatus = (id,msg,type="pending") => {
      const el = $(id);
      if (!el) return;
      el.textContent = msg;
      el.className = `status ${type}`;
      el.style.display = "block";
      log(`Status ${id}`, msg);
    };

    const clearStatus = id => {
      const el = $(id);
      if (el) el.style.display = "none";
    };

    function cleanHandle(raw) {
      return String(raw).trim().split("\n").pop().trim();
    }

    async function connect() {
      try {
        log("Connect","Starting...");
        if (!window.ethereum) throw new Error("MetaMask not installed");

        provider = new BrowserProvider(window.ethereum);
        log("Provider","Created");

        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        address = await signer.getAddress();
        log("Address", address);

        contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);
        log("Contract", CONFIG.CONTRACT_ADDRESS);

        $("#btnConnect").textContent = address.slice(0,6) + "‚Ä¶" + address.slice(-4);

        if (!relayer) {
          log("Relayer","initSDK...");
          await initSDK();
          relayer = await createInstance({
            ...SepoliaConfig,
            relayerUrl: CONFIG.RELAYER_URL,
            gatewayUrl: CONFIG.GATEWAY_URL,
            network: window.ethereum,
            debug: true
          });
          logSuccess("Relayer","Instance created");
        }

        logSuccess("Connect","Ready");
        return true;
      } catch (e) {
        logError("Connect", e);
        setStatus("#biasStatus","‚ùå Wallet connection failed","error");
        return false;
      }
    }

    $("#btnConnect").onclick = connect;

    // encrypt euint8
    async function encrypt8(value) {
      if (!relayer) throw new Error("Relayer not initialized");

      const enc = relayer.createEncryptedInput(
        getAddress(CONFIG.CONTRACT_ADDRESS),
        getAddress(address)
      );
      log("Encrypt8", `add8=${value}`);
      enc.add8(BigInt(value));

      const { handles, inputProof } = await enc.encrypt();
      log("Encrypt8 Result", {
        handleCount: handles.length,
        proofLength: typeof inputProof === "string" ? inputProof.length : inputProof.length
      });

      const raw = handles[0]?.handle || handles[0]?.ciphertext || handles[0];
      const handle = typeof raw === "string" ? raw : toHex(raw);

      const attestation =
        typeof inputProof === "string"
          ? (inputProof.startsWith("0x") ? inputProof : "0x" + inputProof)
          : toHex(inputProof);

      return { handle, attestation };
    }

    // ===== SET BIAS (HOUSE) =====
    $("#btnSetBias").onclick = async () => {
      try {
        log("SetBias","Starting...");
        if (!await connect()) return;

        clearStatus("#biasStatus");
        setStatus("#biasStatus","üîê Encrypting house bias‚Ä¶","pending");

        const bias = parseInt($("#biasInput").value);
        if (bias !== 0 && bias !== 1) throw new Error("Bias must be 0 or 1");

        const { handle, attestation } = await encrypt8(bias);
        log("SetBias Args", {
          handle: handle.slice(0,40) + "...",
          attLen: attestation.length
        });

        setStatus("#biasStatus","‚õìÔ∏è Sending tx‚Ä¶","pending");

        const tx = await contract.setHouseBias(handle, attestation);
        log("SetBias Tx", tx.hash);
        const receipt = await tx.wait();
        log("SetBias Receipt", {
          blockNumber: receipt.blockNumber,
          status: receipt.status
        });

        if (receipt.status !== 1) throw new Error("Transaction reverted");

        setStatus("#biasStatus","‚úÖ House bias stored (encrypted)","success");
      } catch (e) {
        logError("SetBias", e);
        setStatus("#biasStatus","‚ùå " + (e.message || e),"error");
      }
    };

    // ===== PLAYER: PLAY FLIP =====
    $("#btnPlayFlip").onclick = async () => {
      try {
        log("PlayFlip","Starting...");
        if (!await connect()) return;

        clearStatus("#flipStatus");
        setStatus("#flipStatus","üßÆ Encrypting choice‚Ä¶","pending");

        const has = await contract.hasBias();
        if (!has) throw new Error("House bias not set yet");

        const choice = parseInt($("#choiceInput").value);
        if (choice !== 0 && choice !== 1) throw new Error("Choice must be 0 or 1");

        const { handle, attestation } = await encrypt8(choice);
        log("PlayFlip Args", {
          handle: handle.slice(0,40) + "...",
          attLen: attestation.length
        });

        setStatus("#flipStatus","‚õìÔ∏è Sending tx‚Ä¶","pending");

        const tx = await contract.playFlip(handle, attestation);
        log("PlayFlip Tx", tx.hash);
        const receipt = await tx.wait();
        log("PlayFlip Receipt", {
          blockNumber: receipt.blockNumber,
          status: receipt.status
        });

        if (receipt.status !== 1) throw new Error("Transaction reverted");

        setStatus("#flipStatus","üìä Fetching result handle‚Ä¶","pending");

        const fh = await contract.resultHandle(address);
        log("ResultHandle", fh);

        $("#resultHandleOutput").textContent = "Result Handle:\n" + fh;
        $("#resultHandleOutput").style.display = "block";

        setStatus("#flipStatus","‚úÖ Result stored","success");
      } catch (e) {
        logError("PlayFlip", e);
        setStatus("#flipStatus","‚ùå " + (e.message || e),"error");
      }
    };

    // ===== GET RESULT HANDLE =====
    $("#btnGetResultHandle").onclick = async () => {
      try {
        log("GetResultHandle","Starting...");
        if (!await connect()) return;

        setStatus("#decryptResultStatus","üìä Retrieving handle‚Ä¶","pending");
        const fh = await contract.resultHandle(address);
        log("Handle", fh);

        $("#resultHandleOutput").textContent = "Result Handle:\n" + fh;
        $("#resultHandleOutput").style.display = "block";

        setStatus("#decryptResultStatus","‚úÖ Handle retrieved","success");
      } catch (e) {
        logError("GetResultHandle", e);
        setStatus("#decryptResultStatus","‚ùå " + (e.message || e),"error");
      }
    };

    // ===== MAKE RESULT PUBLIC =====
    $("#btnMakeResultPublic").onclick = async () => {
      try {
        log("MakeResultPublic","Starting...");
        if (!await connect()) return;

        setStatus("#decryptResultStatus","üîì Making result public‚Ä¶","pending");

        const tx = await contract.makeMyResultPublic();
        log("MakeResultPublic Tx", tx.hash);
        const receipt = await tx.wait();
        log("MakeResultPublic Receipt", {
          blockNumber: receipt.blockNumber,
          status: receipt.status
        });

        if (receipt.status !== 1) throw new Error("Transaction reverted");

        setStatus("#decryptResultStatus","‚úÖ Result is now public","success");
      } catch (e) {
        logError("MakeResultPublic", e);
        setStatus("#decryptResultStatus","‚ùå " + (e.message || e),"error");
      }
    };

    // ===== PUBLIC DECRYPT RESULT =====
    async function decryptResult(rawHandle) {
      if (!relayer) throw new Error("Relayer not initialized");

      const handle = cleanHandle(rawHandle);
      if (!handle.startsWith("0x") || handle.length !== 66)
        throw new Error("Invalid handle format (must be bytes32)");

      const request = [handle];
      console.log("üîé publicDecrypt request:", request);

      const out = await relayer.publicDecrypt(request);
      console.log("üîç publicDecrypt output:", out);

      if (!out || typeof out !== "object" || !out.clearValues)
        throw new Error("Invalid decrypt response (no clearValues)");

      const v =
        out.clearValues[handle] ??
        out.clearValues[handle.toLowerCase()];

      if (v === undefined) throw new Error("Decrypt produced no value");

      console.log("üîê clear value:", v);
      return Number(v); // 0,1,2
    }

    $("#btnDecryptResult").onclick = async () => {
      try {
        await connect();

        const raw = $("#resultHandleOutput").textContent.trim();
        const handle = cleanHandle(raw);
        console.log("Decrypting handle:", handle);

        setStatus("#decryptResultStatus","üîì Decrypting via relayer‚Ä¶","pending");
        const code = await decryptResult(handle);

        const resultDiv = $("#flipResult");
        let title, desc, cls="match-result";

        if (code === 1) {
          title = "‚úÖ YOU WIN!";
          desc = "Your encrypted choice matches the biased coin outcome.";
        } else if (code === 2) {
          title = "ü§ù PUSH";
          desc = "Special push result: no win, no loss.";
        } else {
          title = "‚ùå YOU LOSE";
          desc = "Your encrypted choice does not match the coin outcome.";
          cls = "match-result no-match";
        }

        resultDiv.className = cls;
        resultDiv.innerHTML =
          `<div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">${title}</div>
           <div style="color:#d1d5db;font-size:14px;">${desc}</div>`;
        resultDiv.style.display = "block";

        setStatus("#decryptResultStatus","‚úÖ Result decrypted","success");
      } catch (e) {
        console.error("Decrypt failed:", e);
        setStatus("#decryptResultStatus","‚ùå " + (e.message || e),"error");
      }
    };

    // ===== WINS: GET HANDLE / MAKE PUBLIC / DECRYPT =====
    $("#btnGetWinsHandle").onclick = async () => {
      try {
        log("GetWinsHandle","Starting...");
        if (!await connect()) return;

        setStatus("#winsStatus","üìä Retrieving wins handle‚Ä¶","pending");
        const fh = await contract.winsHandle(address);
        log("WinsHandle", fh);

        $("#winsHandleOutput").textContent = "Wins Handle:\n" + fh;
        $("#winsHandleOutput").style.display = "block";

        setStatus("#winsStatus","‚úÖ Wins handle retrieved","success");
      } catch (e) {
        logError("GetWinsHandle", e);
        setStatus("#winsStatus","‚ùå " + (e.message || e),"error");
      }
    };

    $("#btnMakeWinsPublic").onclick = async () => {
      try {
        log("MakeWinsPublic","Starting...");
        if (!await connect()) return;

        setStatus("#winsStatus","üîì Making wins public‚Ä¶","pending");

        const tx = await contract.makeMyWinsPublic();
        log("MakeWinsPublic Tx", tx.hash);
        const receipt = await tx.wait();
        log("MakeWinsPublic Receipt", {
          blockNumber: receipt.blockNumber,
          status: receipt.status
        });

        if (receipt.status !== 1) throw new Error("Transaction reverted");

        setStatus("#winsStatus","‚úÖ Wins are now public","success");
      } catch (e) {
        logError("MakeWinsPublic", e);
        setStatus("#winsStatus","‚ùå " + (e.message || e),"error");
      }
    };

    async function decryptWins(rawHandle) {
      if (!relayer) throw new Error("Relayer not initialized");

      const handle = cleanHandle(rawHandle);
      if (!handle.startsWith("0x") || handle.length !== 66)
        throw new Error("Invalid handle format (must be bytes32)");

      const request = [handle];
      console.log("üîé publicDecrypt wins request:", request);

      const out = await relayer.publicDecrypt(request);
      console.log("üîç publicDecrypt wins output:", out);

      if (!out || typeof out !== "object" || !out.clearValues)
        throw new Error("Invalid decrypt response (no clearValues)");

      const v =
        out.clearValues[handle] ??
        out.clearValues[handle.toLowerCase()];

      if (v === undefined) throw new Error("Decrypt produced no value");

      console.log("üîê wins clear value:", v);
      return BigInt(v); // uint16
    }

    $("#btnDecryptWins").onclick = async () => {
      try {
        await connect();

        const raw = $("#winsHandleOutput").textContent.trim();
        const handle = cleanHandle(raw);
        console.log("Decrypting wins handle:", handle);

        setStatus("#winsStatus","üîì Decrypting wins via relayer‚Ä¶","pending");
        const wins = await decryptWins(handle);

        const div = $("#winsResult");
        div.className = "match-result";
        div.innerHTML =
          `<div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">üèÜ TOTAL WINS</div>
           <div style="color:#d1d5db;font-size:14px;">
             You have <strong>${wins.toString()}</strong> encrypted wins against the house.
           </div>`;
        div.style.display = "block";

        setStatus("#winsStatus","‚úÖ Wins decrypted","success");
      } catch (e) {
        console.error("Decrypt wins failed:", e);
        setStatus("#winsStatus","‚ùå " + (e.message || e),"error");
      }
    };

    log("Script","‚úÖ All handlers attached and ready");
  </script>
</body>
</html>
