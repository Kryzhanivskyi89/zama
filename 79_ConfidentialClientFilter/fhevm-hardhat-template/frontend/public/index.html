<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confidential Client Filter — Zama FHEVM</title>
  <link rel="stylesheet" href="./index.css" />
  <!-- <style>
    /* Business, simple, clean UI */
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0f766e;
      --radius:12px;
      --border:#e6e9ee;
      --success:#059669;
      --danger:#dc2626;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:var(--bg);color:#111827;padding:28px}
    .wrap{max-width:820px;margin:30px auto;}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:20px;margin:0}
    p.lead{color:var(--muted);margin:6px 0 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-top:18px}
    label{display:block;font-weight:600;margin-top:10px;color:#111827}
    input[type=number],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;margin-top:6px}
    .row{display:flex;gap:12px;margin-top:12px}
    .col{flex:1}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111827}
    pre{background:#f8fafc;padding:12px;border-radius:8px;border:1px solid var(--border);overflow:auto}
    .status{margin-top:10px;padding:8px;border-radius:8px;font-weight:600}
    .status.ok{background:rgba(5,150,105,0.08);color:var(--success)}
    .status.err{background:rgba(220,38,38,0.08);color:var(--danger)}
    footer{color:var(--muted);font-size:13px;margin-top:22px}
    a.doc{color:var(--accent);text-decoration:none}
  </style> -->

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-glow: 0 0 18px 0 #34ffe4, 0 0 2px #34ffe4;
      --btn-glow: 0 0 0 0 #34ffe4, 0 0 0 #fff, 0 0 32px 0 #34ffe4;
      --background: linear-gradient(135deg, #0e172c 0%, #274456 60%, #35ffc4 120%);
      --glass-bg: rgba(17, 30, 43, 0.67);
      --card-glass: rgba(32, 41, 56, 0.63);
      --border: rgba(53,255,196,0.11);
      --muted: #9ba8b4;
      --accent: #34ffe4;
      --danger: #ff4848;
      --success: #70ff91;
      --font: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      --glass-blur: blur(18px);
      --corner: 22px;
      --space: 32px;
    }
    * {
      font-family: var(--font);
      box-sizing: border-box;
      outline: none;
      transition: background 0.2s, box-shadow 0.18s;
    }
    body {
      margin: 0;
      background: var(--background);
      background-attachment: fixed;
      padding: var(--space);
      color: #e7f8f5;
      min-height: 100vh;
      letter-spacing: 0.018em;
    }
    .wrap {
      max-width: 775px;
      margin: 2.8vw auto 0 auto;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-radius: var(--corner);
      padding: 34px 40px 26px 38px;
      background: var(--card-glass);
      box-shadow: 0 2px 26px 0 #171c2a7b, 0 1.5px 1px 0 #35ffc426;
      backdrop-filter: var(--glass-blur);
      border: 2.3px solid var(--border);
    }
    h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.05em;
      color: #ffffffee;
      font-weight: 700;
      text-shadow: var(--primary-glow);
      background: linear-gradient(90deg,#a7ffef 0%,#34ffe4 75%); 
      -webkit-background-clip: text; color: transparent;
      background-clip: text;
      filter: brightness(1.24);
    }
    p.lead {
      margin: 10px 0 0 4px;
      font-weight: 400;
      color: var(--muted);
      font-size: 1.08rem;
      letter-spacing: 0.08em;
    }
    .card {
      background: var(--glass-bg);
      border-radius: var(--corner);
      box-shadow: 0 9px 44px 0 #15232f32, 0 2px 2px 0 #35ffc430;
      backdrop-filter: var(--glass-blur);
      border: 2.2px solid var(--border);
      padding: 32px 36px 28px 36px;
      margin-top: 36px;
      margin-bottom: 0;
    }
    .card h2 {
      font-size: 1.07rem;
      margin: 0 0 10px;
      font-weight: 600;
      color: #91fff3;
      letter-spacing: 0.033em;
      text-shadow: 0 1px 7px #37ffe4ad;
    }
    .card > p {
      color: #7c8c91;
      font-size: 1rem;
      margin-bottom: 18px;
      margin-top: 2px;
    }
    label {
      font-weight: 600;
      margin-top: 13px;
      color: #b0fff4;
      letter-spacing: 0.07em;
      font-size: 1em;
      margin-bottom: 3px;
      display: block;
      text-shadow: 0 2px 18px #47ffe422;
    }
    select, input[type=number], input[type=text] {
      width: 100%;
      margin-top: 7px;
      font-size: 1.06em;
      background: rgba(41, 61, 75, 0.66);
      color: #eafffa;
      border: none;
      border-radius: 13px;
      padding: 14px 17px;
      margin-bottom: 5px;
      box-shadow: 0 1px 8px #35ffc420;
      outline: none;
      border-bottom: 2.5px solid transparent;
      transition: border 0.2s;
    }
    input:focus, select:focus {
      border-bottom: 2.5px solid var(--accent);
      background: rgba(44, 81, 88, 0.85);
    }
    .row {
      display: flex;
      gap: 18px;
      margin-top: 16px;
    }
    .col {
      flex: 1;
    }
    button {
      font-weight: 600;
      color: #fff;
      padding: 13px 26px;
      border-radius: 15px;
      border: none;
      cursor: pointer;
      background: linear-gradient(100deg, #212f27 6%, #35ffc4 110%);
      box-shadow: var(--btn-glow);
      font-size: 1.03em;
      margin-top: 8px;
      margin-bottom: 0;
      transition: box-shadow 0.15s, background 0.17s;
      letter-spacing: 0.051em;
      position: relative;
      z-index: 1;
    }
    button:hover, button:focus {
      box-shadow: 0 0 15px 0 #40ffe6d3, 0 0 24px #46ffe4, 0 0 32px #45ffb2b4;
      background: linear-gradient(98deg,#35ffc4 0,#30c3a5 120%);
      filter:brightness(1.15);
    }
    button.secondary {
      background: rgba(102,228,220,0.08);
      color: #35ffc4;
      border: 1.2px solid #35ffc493;
      box-shadow: none;
    }
    button.secondary:hover {
      background: rgba(53,255,196,0.18);
      color: #2bffed;
      border: 1.5px solid #35ffc4;
      box-shadow: 0 0 8px #35ffc421;
    }
    pre {
      background: rgba(47,76,80,0.34);
      border-radius: 12px;
      padding: 14px 18px;
      color: #79ffe7;
      margin-top: 17px;
      font-size: 0.95em;
      border: 1.7px solid #35ffc42c;
      overflow-x: auto;
      box-shadow: 0 2px 13px #21efd430;
    }
    .status {
      margin-top: 13px;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1em;
      background: linear-gradient(90deg, #061a18b6 41%, #35ffc408 120%);
      box-shadow: 0 2px 8px #19ffd36c;
    }
    .status.ok {
      color: var(--success);
      border-left: 6.8px solid var(--success);
      border-right: none;
    }
    .status.err {
      color: var(--danger);
      border-left: 6.8px solid var(--danger);
      border-right: none;
    }
    footer {
      color: #5df2d4;
      font-size: 1.02em;
      margin: 38px 0 0 2px;
      background: rgba(15,30,26,0.46);
      border-radius: 14px;
      padding: 17px 25px 13px 23px;
      box-shadow: 0 0 8px #25ffc42f;
      /* display: flex;
      justify-content: space-between; */
      align-items: center;
      backdrop-filter: blur(12px);
      border: 1.7px solid #35ffc426;
    }
    a.doc {
      color:var(--accent);
      text-decoration:underline wavy #34ffe4;
      text-underline-offset: 2px;
      font-weight:700;
      letter-spacing:0.036em;
      transition: color 0.14s;
    }
    a.doc:hover {
      color:#fff;
      text-shadow: var(--primary-glow);
    }
    @media (max-width: 720px) {
      .wrap, header, .glass-card {
        padding: 18px 7vw 16px 7vw;
      }
      .row { flex-direction: column; gap: 0; }
    }
    @media (max-width: 480px) {
      .wrap, header, .glass-card { padding: 7vw 2vw; font-size:90%; }
      footer { flex-direction: column; gap:8px; padding: 3vw 4vw 3vw 4vw;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Confidential Client Filter</h1>
        <p class="lead">Single-user demo — submit encrypted corporate flag & turnover, compute filter & decrypt (Zama FHEVM).</p>
      </div>
      <div>
        <button id="btnConnect">Connect Wallet</button>
      </div>
    </header>

    <!-- Submit client -->
    <section class="card">
      <h2 style="margin:0;font-size:16px">1. Submit your encrypted client profile</h2>
      <p style="color:var(--muted);margin:6px 0 12px">We store only encrypted fields on-chain: <strong>isCorporate</strong> (bool) and <strong>turnover</strong> (uint64).</p>

      <label>Is corporate?</label>
      <select id="isCorporate">
        <option value="1">Yes (corporate)</option>
        <option value="0">No (individual)</option>
      </select>

      <label>Turnover (units)</label>
      <input id="turnover" type="number" min="0" value="100000" />

      <div class="row">
        <button id="btnSubmitClient">Submit Encrypted Profile</button>
        <button id="btnClear" class="secondary">Clear</button>
      </div>

      <div id="submitStatus" class="status" style="display:none"></div>
      <pre id="clientInfo" style="display:none">Client ID: —\nOwner: —\nHandle(s): —</pre>
    </section>

    <!-- Compute filter -->
    <section class="card">
      <h2 style="margin:0;font-size:16px">2. Compute confidential filter</h2>
      <p style="color:var(--muted);margin:6px 0 12px">Filter: <strong>isCorporate AND turnover &ge; threshold</strong>. Threshold is encrypted before call.</p>

      <div class="row">
        <div class="col">
          <label>Client ID</label>
          <input id="clientIdCompute" type="number" min="1" value="1" />
        </div>
        <div class="col">
          <label>Threshold (units)</label>
          <input id="threshold" type="number" min="0" value="50000" />
        </div>
      </div>

      <div class="row">
        <button id="btnCompute">Compute Filter</button>
        <button id="btnGetHandle" class="secondary">Get Handle</button>
      </div>

      <div id="computeStatus" class="status" style="display:none"></div>
      <pre id="handleOutput" style="display:none"></pre>
    </section>

    <!-- Make public & decrypt -->
    <section class="card">
      <h2 style="margin:0;font-size:16px">3. Make public & decrypt</h2>
      <p style="color:var(--muted);margin:6px 0 12px">If the owner makes the result public, anyone can call the relayer to decrypt a bytes32 handle.</p>

      <div class="row">
        <div class="col">
          <label>Client ID</label>
          <input id="clientIdDecrypt" type="number" min="1" value="1" />
        </div>
        <div class="col">
          <label>Handle (bytes32)</label>
          <input id="manualHandle" type="text" placeholder="0x... (or press Get Handle)" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnMakePublic">Make Filter Public (owner only)</button>
        <button id="btnDecrypt" class="secondary">Decrypt Public Handle</button>
      </div>

      <div id="decryptStatus" class="status" style="display:none"></div>
      <pre id="decryptResult" style="display:none"></pre>
    </section>

    <footer>
      <div>Contract: <strong id="contractAddr">0xF71aB6dCfC694F5620420BeFA837e182C202dD12</strong></div>
      <div style="margin-top:6px">Docs / whitepaper: <a class="doc" href="/mnt/data/fhevm_whitepaper_new.pdf" target="_blank">fhevm_whitepaper_new.pdf</a></div>
    </footer>
  </div>

  <script type="module">
    // Relayer SDK + ethers imports (CDN)
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";
    import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";

    // CONFIG
    const CONTRACT_ADDRESS = "0xF71aB6dCfC694F5620420BeFA837e182C202dD12";
    const RELAYER_URL = "https://relayer.testnet.zama.org"; // adjust if needed
    const GATEWAY_URL = "https://gateway.testnet.zama.org";

    // Minimal ABI for our contract (only used functions/events)
    const ABI = [
      "event ClientSubmitted(uint256 indexed clientId, address indexed owner)",
      "function submitClient(bytes32,bytes32,bytes) external returns (uint256)",
      "function computeFilter(uint256,bytes32,bytes) external returns (bytes32)",
      "function makeFilterPublic(uint256) external",
      "function filterHandle(uint256) external view returns (bytes32)",
      "function clientExists(uint256) external view returns (bool)",
      "function clientOwner(uint256) external view returns (address)"
    ];

    // DOM helpers
    const $ = (s) => document.querySelector(s);
    const log = (t, d) => console.log(`[${t}]`, d);
    const logErr = (t, d) => console.error(`[${t}]`, d);

    // Elements
    const btnConnect = $('#btnConnect');
    const btnSubmit = $('#btnSubmitClient');
    const btnClear = $('#btnClear');
    const submitStatus = $('#submitStatus');
    const clientInfo = $('#clientInfo');

    const btnCompute = $('#btnCompute');
    const computeStatus = $('#computeStatus');
    const handleOutput = $('#handleOutput');
    const btnGetHandle = $('#btnGetHandle');

    const btnMakePublic = $('#btnMakePublic');
    const btnDecrypt = $('#btnDecrypt');
    const decryptStatus = $('#decryptStatus');
    const decryptResult = $('#decryptResult');

    // State
    let provider, signer, address, contract, relayer;

    function setStatus(el, msg, ok=true){
      el.style.display = 'block';
      el.textContent = msg;
      el.className = 'status ' + (ok? 'ok' : 'err');
      log('Status', msg);
    }
    function clearStatus(el){ el.style.display='none'; }

    // Connect wallet & init relayer
    async function connect(){
      try{
        log('connect','starting');
        if (!window.ethereum) throw new Error('No Web3 provider found (MetaMask)');
        provider = new BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        address = await signer.getAddress();
        log('address', address);
        btnConnect.textContent = address.slice(0,6) + '…' + address.slice(-4);

        contract = new Contract(getAddress(CONTRACT_ADDRESS), ABI, signer);
        log('contract', CONTRACT_ADDRESS);

        if (!relayer){
          await initSDK();
          relayer = await createInstance({
            ...SepoliaConfig,
            relayerUrl: RELAYER_URL,
            gatewayUrl: GATEWAY_URL,
            network: window.ethereum,
            debug: true
          });
          log('relayer','initialized');
        }

        setStatus(submitStatus, 'Wallet connected', true);
        return true;
      }catch(e){
        logErr('connect', e);
        setStatus(submitStatus, 'Connection failed: '+ (e.message||e), false);
        return false;
      }
    }

    btnConnect.onclick = connect;

    // Submit encrypted client profile (single-user simple flow)
    btnSubmit.onclick = async () => {
      try{
        log('submitClient','start');
        if (!await connect()) return;
        setStatus(submitStatus, 'Encrypting inputs…');

        const isCorp = Number($('#isCorporate').value) === 1 ? true : false;
        const turnover = BigInt(Number($('#turnover').value || 0));

        log('values',{isCorp,turnover:turnover.toString()});

        // create encrypted input
        const enc = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(address));
        // add bool and uint64
        enc.addBool(isCorp);
        enc.add64(turnover);

        const { handles, inputProof } = await enc.encrypt();
        log('encrypt result',{handles,inputProof});

        // Normalize handles and proof
        const h0 = typeof handles[0] === 'string' ? handles[0] : (handles[0]?.handle||handles[0]?.ciphertext||arrayToHex(handles[0]));
        const h1 = typeof handles[1] === 'string' ? handles[1] : (handles[1]?.handle||handles[1]?.ciphertext||arrayToHex(handles[1]));
        const proof = typeof inputProof === 'string' ? (inputProof.startsWith('0x')?inputProof:'0x'+inputProof) : arrayToHex(inputProof);

        log('normalized',{h0,h1,proof});
        setStatus(submitStatus,'Submitting transaction…');

        // call contract: submitClient(externalEbool, externalEuint64, bytes)
        const tx = await contract.submitClient(h0, h1, proof);
        log('txSent',tx.hash);
        const receipt = await tx.wait();
        log('txReceipt', receipt);

        // parse event to extract clientId
        let clientId = null;
        try{
          for(const logEntry of receipt.logs){
            try{
              const parsed = contract.interface.parseLog(logEntry);
              if (parsed && parsed.name === 'ClientSubmitted'){
                clientId = parsed.args.clientId.toString();
                break;
              }
            }catch(_){ /* ignore */ }
          }
        }catch(e){ logErr('parseEvent', e); }

        if (!clientId) clientId = '1';

        clientInfo.style.display = 'block';
        clientInfo.textContent = `Client ID: ${clientId}\nOwner: ${address}\nHandles:\n  isCorporate: ${h0}\n  turnover: ${h1}`;

        setStatus(submitStatus, 'Client submitted. ID: '+clientId, true);
        $('#clientIdCompute').value = clientId;
        $('#clientIdDecrypt').value = clientId;
        log('submitClient','done');
      }catch(e){
        logErr('submitClient', e);
        setStatus(submitStatus, 'Submit failed: '+(e.message||e), false);
      }
    };

    btnClear.onclick = () => {
      $('#isCorporate').value = '1';
      $('#turnover').value = '100000';
      clientInfo.style.display = 'none';
      clearStatus(submitStatus);
    };

    // Compute filter: encrypt threshold and call computeFilter
    btnCompute.onclick = async () => {
      try{
        log('compute','start');
        if (!await connect()) return;
        setStatus(computeStatus, 'Verifying client…');

        const clientId = Number($('#clientIdCompute').value);
        const threshold = BigInt(Number($('#threshold').value || 0));

        const exists = await contract.clientExists(clientId);
        if (!exists) throw new Error('Client does not exist onchain');

        setStatus(computeStatus, 'Encrypting threshold…');
        const enc = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(address));
        enc.add64(threshold);
        const { handles, inputProof } = await enc.encrypt();

        const thrHandle = typeof handles[0] === 'string' ? handles[0] : (handles[0]?.handle||handles[0]?.ciphertext||arrayToHex(handles[0]));
        const proof = typeof inputProof === 'string' ? (inputProof.startsWith('0x')?inputProof:'0x'+inputProof) : arrayToHex(inputProof);

        log('thresholdNormalized',{thrHandle,proof});
        setStatus(computeStatus, 'Calling contract.computeFilter…');

        const tx = await contract.computeFilter(clientId, thrHandle, proof);
        log('txSent', tx.hash);
        const receipt = await tx.wait();
        log('txReceipt', receipt);

        // After compute, call filterHandle to get bytes32 handle
        const handle = await contract.filterHandle(clientId);
        log('filterHandle', handle);

        handleOutput.style.display = 'block';
        handleOutput.textContent = handle;
        setStatus(computeStatus, 'Filter computed. Handle retrieved.', true);
      }catch(e){
        logErr('compute', e);
        setStatus(computeStatus, 'Compute failed: '+(e.message||e), false);
      }
    };

    // Get existing handle
    btnGetHandle.onclick = async () => {
      try{
        if (!await connect()) return;
        const cid = Number($('#clientIdCompute').value);
        const hv = await contract.filterHandle(cid);
        handleOutput.style.display = 'block';
        handleOutput.textContent = hv;
        setStatus(computeStatus, 'Handle loaded', true);
        $('#manualHandle').value = hv;
      }catch(e){ logErr('getHandle', e); setStatus(computeStatus, 'Get handle failed: '+(e.message||e), false); }
    };

    // Make public (owner-only)
    btnMakePublic.onclick = async () => {
      try{
        if (!await connect()) return;
        const cid = Number($('#clientIdDecrypt').value);
        setStatus(decryptStatus, 'Sending makeFilterPublic tx…');
        const tx = await contract.makeFilterPublic(cid);
        log('makePublic tx', tx.hash);
        const receipt = await tx.wait();
        log('makePublic receipt', receipt);
        setStatus(decryptStatus, 'Filter marked public (decryptable)', true);
      }catch(e){ logErr('makePublic', e); setStatus(decryptStatus, 'Make public failed: '+(e.message||e), false); }
    };

    // Decrypt public handle using relayer.publicDecrypt([bytes32]) and new format
    btnDecrypt.onclick = async () => {
      try{
        if (!await connect()) return;
        let handle = $('#manualHandle').value.trim();
        if (!handle){
          handle = handleOutput.textContent.trim();
        }
        handle = handle.split('\n').pop().trim();
        log('decrypt','raw handle', handle);

        if (!handle.startsWith('0x') || handle.length !== 66) throw new Error('Handle must be bytes32');

        setStatus(decryptStatus, 'Requesting public decrypt…');
        // MUST send array of bytes32
        const out = await relayer.publicDecrypt([handle]);
        log('publicDecrypt out', out);

        if (!out || typeof out !== 'object' || !out.clearValues) {
          throw new Error('Unexpected decrypt response format');
        }

        const lower = handle.toLowerCase();
        const value = out.clearValues[handle] ?? out.clearValues[lower];
        if (value === undefined) throw new Error('No clear value returned for this handle');

        log('clearValue', value);
        decryptResult.style.display = 'block';
        decryptResult.textContent = `Clear value: ${value} — (${Number(value)===1? 'MATCH' : 'NO MATCH'})`;
        setStatus(decryptStatus, 'Decryption complete', true);
      }catch(e){ logErr('decrypt', e); setStatus(decryptStatus, 'Decrypt failed: '+(e.message||e), false); }
    };

    // helper to convert Uint8Array to 0x hex
    function arrayToHex(a){
      if (!a) return '0x';
      if (typeof a === 'string') return a;
      try{
        return '0x' + Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){ return String(a); }
    }

    log('script','ready');
  </script>
</body>
</html>
